<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Alert Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap" rel="stylesheet" />
    <style>
      body {
        background: linear-gradient(120deg, #010314, #090c1b);
        color: #ffffff;
        font-family: 'Orbitron', sans-serif;
      }
  
      .navbar {
        background: rgba(0, 0, 0, 0.85);
        box-shadow: 0 0 15px rgba(255, 0, 94, 0.3);
      }
  
      .navbar-brand {
        font-family: 'Orbitron', sans-serif;
        background: linear-gradient(to right, #00c6ff, #0072ff, #a800ff, #ff005e);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 1.8rem;
    }
  
      .nav-link {
        position: relative;
        color: #ffffff !important;
        margin-right: 1rem;
        font-weight: 600;
      }
  
      .nav-link::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 0;
        height: 2px;
        width: 100%;
        background: #ff005e;
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
      }
  
      .nav-link:hover::after {
        transform: scaleX(1);
      }
  
      .nav-link.logout {
        color: #ff005e !important;
      }
  
      .dashboard-header {
        text-align: center;
        margin: 2rem 0;
      }
  
      .table-wrapper {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        backdrop-filter: blur(5px);
        box-shadow: 0 0 20px rgba(255, 0, 94, 0.1);
      }
  
      .form-label {
        color: #ffc8e0;
      }
  
      .form-select {
        background-color: #1b1b2f;
        color: #ffffff;
        border: 1px solid #ff005e;
      }
  
      .footer {
        background: linear-gradient(145deg, #0a0a0a, #1a1a2e);
        color: #ccc;
        padding: 1rem 0;
        text-align: center;
      }
  
      .btn-outline-primary {
        border-color: #ff005e;
        color: #ff005e;
      }
  
      .btn-outline-primary:hover {
        background-color: #ff005e;
        color: #fff;
      }
  
      .btn-primary {
        background-color: #ff005e;
        border-color: #ff005e;
      }
  
      .btn-primary:hover {
        background-color: #e6004c;
        border-color: #e6004c;
      }

      table {
        font-size: 0.9rem;
      }

      .toast {
        background: linear-gradient(to right, #ff005e, #5a00ff);
        box-shadow: 0 0 15px rgba(255, 0, 94, 0.3);
        border-radius: 10px;
        font-weight: 500;
      }

      .badge{
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
      }

      .badge.bg-fire {
        background-color: #ff005e;
        color: #fff;
      }

      .badge.bg-crowd {
        background-color: #ffc107;
        color: #000;
      }

      .badge.bg-gun {
        background-color: #343a40;
        color: #fff;
      }

      .badge.bg-unknown {
        background-color: #6c757d;
        color: #fff;
      }
      
    </style>  
  </head>
  <body>
    <!-- üîº Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="/">AEGiSS</a>
      <div class="d-flex">
        <a class="nav-link" href="/">Home</a>
        <a class="nav-link" href="{% url 'detector:upload' %}">Upload</a>
        <a class="nav-link" href="{% url 'detector:live_page' %}">Live</a>
        <a class="nav-link" href="{% url 'detector:insights' %}">Insights</a>
        <a class="nav-link logout" href="{% url 'logout' %}">Logout</a>
      </div>
    </div>
  </nav>

  <!-- üî• Dashboard -->
  <div class="container py-3 mb-5">
    <div class="dashboard-header">
      <h2 class="display-5 text-light fw-bold">Real-time Alert Dashboard</h2>
    </div>

    <div class="row mb-4">
      <div class="col-md-4">
        <label class="form-label">Filter by Label</label>
        <select id="filterLabel" class="form-select">
          <option value="">All</option>
          <option value="Fire">Fire</option>
          <option value="Crowd">Crowd</option>
          <option value="Gun">Gun</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Filter by Type</label>
        <select id="filterType" class="form-select">
          <option value="">All</option>
          <option value="uploaded">Uploaded</option>
          <option value="webcam">Webcam</option>
        </select>
      </div>
    </div>

    <div class="table-wrapper p-3">
      <table class="table table-dark table-bordered table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Time</th>
            <th>Label</th>
            <th>Confidence (%)</th>
            <th>Timestamp (s)</th>
            <th>Video Title</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody id="alerts">
          <!-- Firebase injected rows -->
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-4">
      <button class="btn btn-outline-primary" id="prevPage">Previous</button>
      <span id="pageInfo" class="fw-bold"></span>
      <button class="btn btn-outline-primary" id="nextPage">Next</button>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div id="toastContainer"></div>
  </div>

  <!-- üîΩ Footer -->
  <footer class="footer mt-auto">
    <div class="container">
      <p>&copy; 2025 AEGiSS | Powered by AI Surveillance Intelligence</p>
    </div>
  </footer>

    <!-- ‚úÖ Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCsdS9YnvMKObOgqUwH3zyusaCFh7HEs2g",
        authDomain: "aegis-1f952.firebaseapp.com",
        databaseURL: "https://aegis-1f952-default-rtdb.firebaseio.com",
        projectId: "aegis-1f952",
        storageBucket: "aegis-1f952.firebasestorage.app",
        messagingSenderId: "388139893179",
        appId: "1:388139893179:web:1b9b7cebbe4d17521cc49e",
        measurementId: "G-1BT82MBJ9J",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const alertsRef = db.ref("alerts");
      let allEntries = [];

      let currentPage = 1;
      const entriesPerPage = 10;
      let filteredEntries = [];

      function renderTable(data) {
        const tbody = document.getElementById("alerts");
        tbody.innerHTML = "";

        const startIndex = (currentPage - 1) * entriesPerPage;
        const paginatedData = data.slice(
          startIndex,
          startIndex + entriesPerPage
        );

        paginatedData.forEach((alert) => {
          let badgeClass = "";
          let icon = "";

          switch (alert.label) {
            case "Fire":
              badgeClass = "fire";
              icon = "üî•";
              break;
            case "Crowd":
              badgeClass = "crowd";
              icon = "üë•";
              break;
            case "Gun":
              badgeClass = "gun";
              icon = "üî´";
              break;
            default:
              badgeClass = "unknown";
              icon = "‚ùì";
          }

          const row = document.createElement("tr");
          row.className = "alert-row";
          row.innerHTML = `
            <td>${new Date(alert.time * 1000).toLocaleTimeString()}</td>
            <td><span class="badge bg-${badgeClass} fs-6">${icon} ${
            alert.label
          }</span></td>
            <td>${alert.confidence}</td>
            <td>${alert.timestamp}</td>
            <td>${alert.video_title}</td>
            <td><span class="badge bg-info">${alert.type}</span></td>
          `;
          tbody.appendChild(row);
        });

        updatePaginationControls(data.length);
      }

      function updatePaginationControls(totalEntries) {
        const totalPages = Math.ceil(totalEntries / entriesPerPage);
        document.getElementById(
          "pageInfo"
        ).innerText = `Page ${currentPage} of ${totalPages}`;

        document.getElementById("prevPage").disabled = currentPage === 1;
        document.getElementById("nextPage").disabled =
          currentPage === totalPages || totalPages === 0;
      }

      function applyFilters() {
        const label = document.getElementById("filterLabel").value;
        const type = document.getElementById("filterType").value;

        filteredEntries = allEntries.filter((alert) => {
          const matchLabel = !label || alert.label === label;
          const matchType = !type || alert.type === type;
          return matchLabel && matchType;
        });

        currentPage = 1; // Reset to page 1 on new filter
        renderTable(filteredEntries);
      }

      let lastSeenTimestamps = new Set();

      function showToast(alert) {
        const toastContainer = document.getElementById("toastContainer");
        const toast = document.createElement("div");

        let bgClass = "bg-secondary";
        switch (alert.label) {
          case "Fire":
            bgClass = "bg-danger text-white";
            break;
          case "Gun":
            bgClass = "bg-dark text-white";
            break;
          case "Crowd":
            bgClass = "bg-warning text-dark";
            break;
        }

        toast.className = `toast align-items-center text-white ${bgClass} border-0 mb-2`;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");

        toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body fw-semibold">
        ${alert.label} detected in <strong>${alert.video_title}</strong> at ${alert.timestamp}s (${alert.type})
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;

        toastContainer.appendChild(toast);

        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();

        // Auto-remove after hidden
        toast.addEventListener("hidden.bs.toast", () => toast.remove());
      }

      // Firebase Fetch
      alertsRef.on("value", (snapshot) => {
        const newEntries = [];
        const currentTimestamps = new Set();

        const allData = snapshot.val();
        if (!allData) return;

        Object.entries(allData).forEach(([videoId, alerts]) => {
          Object.entries(alerts).forEach(([timestamp, alert]) => {
            const composedKey = `${videoId}_${timestamp}`;
            currentTimestamps.add(composedKey);

            const fullAlert = {
              ...alert,
              time: parseInt(timestamp),
              key: composedKey,
            };
            newEntries.push(fullAlert);

            if (!lastSeenTimestamps.has(composedKey)) {
              showToast(fullAlert);
            }
          });
        });

        lastSeenTimestamps = currentTimestamps;
        newEntries.sort((a, b) => b.time - a.time);

        allEntries = newEntries;
        applyFilters();
      });

      // Pagination button events
      document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable(filteredEntries);
        }
      });

      document.getElementById("nextPage").addEventListener("click", () => {
        const totalPages = Math.ceil(filteredEntries.length / entriesPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderTable(filteredEntries);
        }
      });

      // Filter change events
      document
        .getElementById("filterLabel")
        .addEventListener("change", applyFilters);
      document
        .getElementById("filterType")
        .addEventListener("change", applyFilters);
    </script>
  </body>
</html>
